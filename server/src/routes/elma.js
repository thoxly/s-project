const express = require('express');
const axios = require('axios');
const router = express.Router();
const mongoose = require('mongoose');

// ELMA365 API configuration
const ELMA_API_URL = process.env.ELMA_API_URL;
const ELMA_TOKEN = process.env.ELMA_TOKEN;

// –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å, –µ—Å–ª–∏ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
let SupportRequest;
try {
  SupportRequest = require('../models/SupportRequest');
} catch (error) {
  console.warn('‚ö†Ô∏è  SupportRequest model not available');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
const isMongoConnected = () => {
  const readyState = mongoose.connection.readyState;
  const hasModel = !!SupportRequest;
  return readyState === 1 && hasModel;
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è solution_description –∏–∑ ELMA API
const fetchSolutionFromElma = async (idElmaApp) => {
  try {
    const response = await fetch(
      `https://og4d3xrizqpay.elma365.ru/pub/v1/app/service_desk/applications/${idElmaApp}/get`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bearer 94803282-2c5f-44f1-a57f-d59552040232`,
          'Content-Type': 'application/json',
        },
      }
    );

    if (!response.ok) {
      console.error(`‚ùå ELMA API error: ${response.status}`);
      return null;
    }

    const data = await response.json();
    
    if (data.success && data.item && data.item.solution_description) {
      return data.item.solution_description;
    }
    
    return null;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ ELMA: ${error.message}`);
    return null;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è solution_description –∏–∑ –¥–∞–Ω–Ω—ã—Ö webhook
const extractSolutionDescription = (applicationData) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º solution_description –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
  if (applicationData.solution_description !== null && 
      applicationData.solution_description !== undefined && 
      applicationData.solution_description !== '-') {
    return applicationData.solution_description;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ context (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
  if (applicationData.context?.solution_description !== null && 
      applicationData.context?.solution_description !== undefined && 
      applicationData.context?.solution_description !== '-') {
    return applicationData.context.solution_description;
  }
  
  return null;
};

// CORS middleware –¥–ª—è —ç—Ç–æ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞ - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –õ–ò–ë–ï–†–ê–õ–¨–ù–ê–Ø –ü–û–õ–ò–¢–ò–ö–ê
router.use((req, res, next) => {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, X-Forwarded-For');
  res.header('Access-Control-Expose-Headers', 'Content-Type, Authorization');
  res.header('Access-Control-Max-Age', '86400');
  res.header('Access-Control-Allow-Credentials', 'false');
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º preflight –∑–∞–ø—Ä–æ—Å—ã —Å—Ä–∞–∑—É
  if (req.method === 'OPTIONS') {
    console.log('üîç OPTIONS –∑–∞–ø—Ä–æ—Å –≤ —Ä–æ—É—Ç–µ—Ä–µ elma:', req.path);
    res.status(204).end();
    return;
  }
  next();
});
router.post('/get_application', async (req, res) => {
  // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ–º 200 OK, —á—Ç–æ–±—ã ELMA –Ω–µ –ø–æ–ª—É—á–∞–ª 502
  try {
    const applicationData = req.body;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º id_portal, —Å—Ç–∞—Ç—É—Å –∏ id_elma_app –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    let idPortal = null;
    let newStatus = null;
    let idElmaApp = null;

    // –í–∞—Ä–∏–∞–Ω—Ç 1: ELMA –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é { id: "...", status: "..." }
    if (applicationData.id_portal || applicationData.id) {
      idPortal = applicationData.id_portal || applicationData.id;
    }
    
    // –í–∞—Ä–∏–∞–Ω—Ç 2: –¥–∞–Ω–Ω—ã–µ –≤ context (–¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)
    if (applicationData.context && applicationData.context.id_portal) {
      idPortal = applicationData.context.id_portal;
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å (ELMA –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –ø–æ–ª–µ "status")
    if (applicationData.status) {
      newStatus = applicationData.status;
    } else if (applicationData.currentStatus) {
      newStatus = applicationData.currentStatus;
    } else if (applicationData.context && applicationData.context.status) {
      newStatus = applicationData.context.status;
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º id_elma_app (ELMA –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –ø–æ–ª–µ "id_elma_app" –∏–ª–∏ "__id")
    if (applicationData.id_elma_app) {
      idElmaApp = applicationData.id_elma_app;
    } else if (applicationData.__id) {
      idElmaApp = applicationData.__id;
    } else if (applicationData.context && applicationData.context.id_elma_app) {
      idElmaApp = applicationData.context.id_elma_app;
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º solution_description –∏–∑ –¥–∞–Ω–Ω—ã—Ö ELMA
    const solutionDescription = extractSolutionDescription(applicationData);

    console.log(`üì• ELMA Webhook: ${idPortal} | –°—Ç–∞—Ç—É—Å: ${newStatus || '–Ω–µ —É–∫–∞–∑–∞–Ω'} | solution_description: ${solutionDescription ? '‚úÖ' : '‚Äî'}`);

    // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ id_portal –Ω–µ "-" (—ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ—à–∏–±–∫—É –æ—Ç ELMA)
    if (!idPortal || idPortal === '-' || idPortal === 'undefined') {
      console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id_portal:', idPortal);
      console.error('üìã –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç ELMA:', JSON.stringify(applicationData, null, 2));
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º 200 OK, —á—Ç–æ–±—ã ELMA –Ω–µ –ø–æ–ª—É—á–∞–ª 502
      return res.status(200).json({ 
        success: true,
        warning: `–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id_portal (${idPortal}), –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ELMA –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id_portal.`,
        receivedData: applicationData
      });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –≤ MongoDB
    if (isMongoConnected()) {
      try {
        // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞—è–≤–∫—É
        const existingRequest = await SupportRequest.findOne({ 
          'context.id_portal': idPortal 
        });

        if (existingRequest) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞—è–≤–∫—É
          const updateData = {
            updatedAt: new Date()
          };

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
          if (newStatus) {
            updateData.currentStatus = newStatus;
          }

          // –ï—Å–ª–∏ –µ—Å—Ç—å id_elma_app, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ELMA API
          let fetchedSolution = null;
          if (idElmaApp) {
            console.log(`üîÑ –ó–∞–ø—Ä–æ—Å solution_description –∏–∑ ELMA API –¥–ª—è ${idElmaApp}`);
            fetchedSolution = await fetchSolutionFromElma(idElmaApp);
            if (fetchedSolution) {
              console.log(`‚úÖ solution_description –ø–æ–ª—É—á–µ–Ω –∏–∑ ELMA API`);
            }
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º context —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç ELMA
          if (applicationData.context) {
            updateData.context = { ...existingRequest.context, ...applicationData.context };
            updateData.context.id_portal = idPortal;
            
            if (idElmaApp) {
              updateData.context.id_elma_app = idElmaApp;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: fetchedSolution > webhook solution_description
            if (fetchedSolution !== null) {
              updateData.context.solution_description = fetchedSolution;
            } else if (solutionDescription !== null) {
              updateData.context.solution_description = solutionDescription;
            }
          } else {
            // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –æ—Ç ELMA (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—á–∞–π)
            updateData.context = {
              ...existingRequest.context,
              id_portal: idPortal,
              application_text: applicationData.description || existingRequest.context?.application_text,
              ...(applicationData.type && { service: [applicationData.type] }),
              ...(applicationData.assignee && { responsible: [applicationData.assignee] }),
              ...(applicationData.initiator && { aplicant: [applicationData.initiator] }),
            };
            
            if (idElmaApp) {
              updateData.context.id_elma_app = idElmaApp;
            }
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: fetchedSolution > webhook solution_description
            if (fetchedSolution !== null) {
              updateData.context.solution_description = fetchedSolution;
            } else if (solutionDescription !== null) {
              updateData.context.solution_description = solutionDescription;
            }
          }

          const updatedRequest = await SupportRequest.findOneAndUpdate(
            { 'context.id_portal': idPortal },
            updateData,
            { new: true, runValidators: false }
          );

          console.log(`‚úÖ –ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${idPortal} | ${updatedRequest.currentStatus}`);

          return res.status(200).json({ 
            success: true,
            message: '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö',
            data: updatedRequest
          });
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å id_elma_app, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ELMA API
          let fetchedSolution = null;
          if (idElmaApp) {
            console.log(`üîÑ –ó–∞–ø—Ä–æ—Å solution_description –∏–∑ ELMA API –¥–ª—è ${idElmaApp}`);
            fetchedSolution = await fetchSolutionFromElma(idElmaApp);
            if (fetchedSolution) {
              console.log(`‚úÖ solution_description –ø–æ–ª—É—á–µ–Ω –∏–∑ ELMA API`);
            }
          }
          
          const contextData = applicationData.context || {
            id_portal: idPortal,
            application_text: applicationData.description || applicationData.application_text || '-',
            ...(applicationData.type && { service: [applicationData.type] }),
            ...(applicationData.assignee && { responsible: [applicationData.assignee] }),
            ...(applicationData.initiator && { aplicant: [applicationData.initiator] }),
          };
          
          if (idElmaApp) {
            contextData.id_elma_app = idElmaApp;
          }
          
          // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: fetchedSolution > webhook solution_description
          if (fetchedSolution !== null) {
            contextData.solution_description = fetchedSolution;
          } else if (solutionDescription !== null) {
            contextData.solution_description = solutionDescription;
          }
          
          const newRequest = new SupportRequest({
            context: contextData,
            currentStatus: newStatus || '–ù–æ–≤–∞—è',
            sentAt: new Date()
          });

          const savedRequest = await newRequest.save();
          console.log(`üÜï –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ${idPortal} | ${savedRequest.currentStatus}`);

          return res.status(200).json({ 
            success: true,
            message: '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö',
            data: savedRequest
          });
        }
      } catch (dbError) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –ë–î: ${dbError.message}`);
        return res.status(200).json({ 
          success: true,
          warning: 'Webhook –ø–æ–ª—É—á–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î',
          error: dbError.message,
          receivedData: applicationData
        });
      }
    } else {
      console.warn('‚ö†Ô∏è  MongoDB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
      return res.status(200).json({ 
        success: true,
        warning: 'MongoDB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞, –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
        receivedData: applicationData
      });
    }
  } catch (error) {
    console.error(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`);
    return res.status(200).json({ 
      success: true,
      warning: 'Webhook –ø–æ–ª—É—á–µ–Ω, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ',
      error: error.message 
    });
  }
});
// Endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ (legacy, –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
// –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ MongoDB —á–µ—Ä–µ–∑ /get_application
router.post('/check_status', async (req, res) => {
  try {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, X-Forwarded-For');
    
    console.log('‚ÑπÔ∏è  /check_status –≤—ã–∑–≤–∞–Ω (legacy endpoint, —Å—Ç–∞—Ç—É—Å—ã —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ MongoDB)');
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —Ç–∞–∫ –∫–∞–∫ –±—É—Ñ–µ—Ä –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    res.json([]);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ /check_status: ', error);
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, X-Forwarded-For');
    res.status(500).json({ error: error.message });
  }
});
router.post('/post_application', async (req, res) => {
  try {
    // req.body ‚Äî —ç—Ç–æ defaultRequestContext, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à—ë–ª —Å —Ñ—Ä–æ–Ω—Ç–∞
    const applicationData = req.body;
    console.log(applicationData)
    const response = await fetch('https://og4d3xrizqpay.elma365.ru/pub/v1/app/service_desk/applications/create', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer 94803282-2c5f-44f1-a57f-d59552040232`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(applicationData), // ‚Üê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–ª–æ, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å —Ñ—Ä–æ–Ω—Ç–∞
    });

    if (!response.ok) {
      throw new Error(`–û—à–∏–±–∫–∞ –æ—Ç ELMA: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ ELMA:', error);
    res.status(500).json({ error: error.message });
  }
});
router.post('/get_data', async (req, res) => {
  try {
    const response = await fetch('https://og4d3xrizqpay.elma365.ru/api/extensions/583d4eea-7f06-47fd-b078-a0caf4f83095/script/post_articles', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer 94803282-2c5f-44f1-a57f-d59552040232`,
        'Content-Type': 'application/json'
      },
    });

    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
// Create support request in ELMA365
router.post('/support', async (req, res) => {
  try {
    const { title, description, priority, userId } = req.body;
    
    // Mock response for development
    if (!ELMA_API_URL || !ELMA_TOKEN) {
      return res.json({
        success: true,
        processInstanceId: `mock-${Date.now()}`,
        message: 'Mock ELMA integration - request created successfully'
      });
    }
    
    // Real ELMA365 integration
    const elmaPayload = {
      title,
      description,
      priority: priority || 'normal',
      userId,
      timestamp: new Date().toISOString()
    };
    
    const response = await axios.post(`${ELMA_API_URL}/processes/support/start`, elmaPayload, {
      headers: {
        'Authorization': `Bearer ${ELMA_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    
    res.json({
      success: true,
      processInstanceId: response.data.processInstanceId,
      message: 'Request created in ELMA365'
    });
    
  } catch (error) {
    console.error('ELMA integration error:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to create request in ELMA365',
      details: error.message
    });
  }
});

// Get process status from ELMA365
router.get('/status/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // Mock response for development
    if (!ELMA_API_URL || !ELMA_TOKEN) {
      return res.json({
        processInstanceId: id,
        status: 'in_progress',
        message: 'Mock ELMA integration - status retrieved'
      });
    }
    
    // Real ELMA365 integration
    const response = await axios.get(`${ELMA_API_URL}/processes/${id}/status`, {
      headers: {
        'Authorization': `Bearer ${ELMA_TOKEN}`
      }
    });
    
    res.json(response.data);
    
  } catch (error) {
    console.error('ELMA status check error:', error);
    res.status(500).json({
      error: 'Failed to get process status',
      details: error.message
    });
  }
});

module.exports = router;
